<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Analytics | Heartfulness</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.39.0/dist/umd/supabase.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js"></script>
    <!-- Confetti for Celebrations -->
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>

    <style>
        :root {
            --bg: #F8FAFC;
            --surface: #FFFFFF;
            --primary: #4F46E5;
            --primary-dark: #4338CA;
            --accent: #10B981;
            --accent-glow: rgba(16, 185, 129, 0.4);
            --text-main: #1E293B;
            --text-muted: #64748B;
            --border: #E2E8F0;
            --shadow-sm: 0 1px 3px rgba(0, 0, 0, 0.05);
            --shadow-lg: 0 10px 25px -5px rgba(0, 0, 0, 0.1), 0 8px 10px -6px rgba(0, 0, 0, 0.1);
        }

        /* RESET */
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Inter', sans-serif;
            background: var(--bg);
            color: var(--text-main);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            overflow-x: hidden;
        }

        /* UTILS */
        .container {
            width: 100%;
            max-width: 800px;
            margin: 0 auto;
            padding: 1.5rem;
        }

        .hidden {
            display: none !important;
        }

        .fade-in {
            animation: fadeIn 0.6s cubic-bezier(0.16, 1, 0.3, 1) forwards;
            opacity: 0;
            transform: translateY(20px);
        }

        @keyframes fadeIn {
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* CARDS */
        .glass-card {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.6);
            border-radius: 20px;
            padding: 1.5rem;
            box-shadow: var(--shadow-lg);
            margin-bottom: 1.5rem;
            position: relative;
            overflow: hidden;
        }

        .glass-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 4px;
            background: linear-gradient(90deg, var(--primary), var(--accent));
        }

        /* TYPOGRAPHY */
        h1 {
            font-size: 1.5rem;
            font-weight: 800;
            letter-spacing: -0.02em;
            margin-bottom: 0.2rem;
            background: linear-gradient(to right, var(--primary), var(--primary-dark));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        h2 {
            font-size: 1.1rem;
            font-weight: 700;
            margin-bottom: 1rem;
            color: var(--text-main);
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .label {
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: var(--text-muted);
            margin-bottom: 0.25rem;
        }

        .value {
            font-size: 1.25rem;
            font-weight: 700;
            color: var(--text-main);
        }

        /* PROFILE HEADER */
        .profile-header {
            display: flex;
            align-items: center;
            gap: 1rem;
            margin-bottom: 2rem;
        }

        .avatar-lg {
            width: 64px;
            height: 64px;
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            color: white;
            border-radius: 20px;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 1.5rem;
            font-weight: 700;
            box-shadow: 0 4px 12px rgba(79, 70, 229, 0.2);
        }

        /* METRICS GRID */
        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 1rem;
            margin-bottom: 1.5rem;
        }

        .metric-box {
            background: var(--surface);
            padding: 1rem;
            border-radius: 12px;
            border: 1px solid var(--border);
            text-align: center;
        }

        /* LOADER */
        #loader {
            position: fixed;
            inset: 0;
            background: var(--bg);
            z-index: 100;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid var(--border);
            border-top-color: var(--primary);
            border-radius: 50%;
            animation: spin 0.8s ease-in-out infinite;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }
    </style>
</head>

<body>

    <div id="loader">
        <div class="spinner"></div>
        <div style="margin-top:1rem; font-weight:500; font-size:0.9rem; color:var(--text-muted)">Loading Analytics...
        </div>
    </div>

    <div class="container hidden" id="main-content">
        <!-- USER HEADER -->
        <div class="profile-header fade-in" style="animation-delay: 0.1s">
            <div class="avatar-lg" id="u-avatar">?</div>
            <div>
                <div class="label" style="margin-bottom:0">Protégé Profile</div>
                <h1 id="u-name" style="font-size:1.8rem">Loading...</h1>
                <div style="font-size:0.9rem; color:var(--text-muted); display:flex; gap:0.5rem; align-items:center">
                    <i class="fa-solid fa-location-dot"></i> <span id="u-loc">-</span>
                </div>
            </div>
            <div style="flex:1"></div>
            <!-- Dynamic Badge -->
            <div id="u-badge"
                style="padding:0.4rem 0.8rem; background:white; border-radius:99px; font-weight:600; font-size:0.8rem; box-shadow:var(--shadow-sm); color:var(--primary)">
                Heartfulness
            </div>
        </div>

        <!-- CONTEXT CARD (Task or Habit Info) -->
        <div class="glass-card fade-in" style="animation-delay: 0.2s">
            <h2 id="ctx-title"><i class="fa-solid fa-layer-group"></i> Activity Details</h2>
            <div style="display:flex; justify-content:space-between; align-items:flex-end">
                <div>
                    <div class="label">Activity Name</div>
                    <div class="value" id="ctx-name">...</div>
                    <div style="font-size:0.9rem; color:var(--text-muted); margin-top:0.25rem" id="ctx-desc">
                        Description...</div>
                </div>
                <div style="text-align:right">
                    <div class="label" id="ctx-meta-label">Assigned Date</div>
                    <div class="value" id="ctx-meta-val" style="font-size:1rem">-</div>
                </div>
            </div>
        </div>

        <!-- TASK ANALYTICS VIEW -->
        <div id="view-task" class="hidden">
            <div class="metrics-grid fade-in" style="animation-delay: 0.3s">
                <div class="metric-box">
                    <div class="label">Status</div>
                    <div class="value" id="t-status" style="text-transform:capitalize">-</div>
                </div>
                <div class="metric-box">
                    <div class="label">Days Remaining</div>
                    <div class="value" id="t-days">-</div>
                </div>
            </div>

            <div class="glass-card fade-in" style="animation-delay: 0.4s">
                <div style="display:flex; justify-content:space-between; margin-bottom:1rem">
                    <h2><i class="fa-solid fa-chart-simple"></i> Peer Comparison</h2>
                    <select
                        style="border:none; background:transparent; font-size:0.85rem; font-weight:600; color:var(--primary); cursor:pointer">
                        <option>Global Average</option>
                    </select>
                </div>
                <!-- Chart: Speed vs Others -->
                <div style="height:220px; width:100%">
                    <canvas id="chart-task-peer"></canvas>
                </div>
                <p style="text-align:center; margin-top:1rem; font-size:0.85rem; color:var(--text-muted)">
                    Comparing completion time against cohort average.
                </p>
            </div>

            <div class="metrics-grid">
                <div class="glass-card">
                    <h2><i class="fa-solid fa-clock-rotate-left"></i> Timeliness Trend</h2>
                    <div style="height:200px"><canvas id="chart-task-time"></canvas></div>
                </div>
                <div class="glass-card">
                    <h2><i class="fa-solid fa-bullseye"></i> Category Performance</h2>
                    <div style="height:200px"><canvas id="chart-task-cat"></canvas></div>
                </div>
            </div>
        </div>

        <!-- HABIT ANALYTICS VIEW -->
        <div id="view-habit" class="hidden">
            <div class="metrics-grid fade-in" style="animation-delay: 0.3s">
                <div class="metric-box">
                    <div class="label">Current Streak</div>
                    <div class="value" id="h-streak" style="color:var(--primary)">-</div>
                </div>
                <div class="metric-box">
                    <div class="label">Best Streak</div>
                    <div class="value" id="h-best" style="color:var(--accent)">-</div>
                </div>
            </div>

            <div class="metrics-grid">
                <div class="glass-card fade-in" style="animation-delay: 0.4s">
                    <h2><i class="fa-solid fa-fire-flame-curved"></i> Consistency Curve</h2>
                    <div style="height:200px; width:100%">
                        <canvas id="chart-habit-trend"></canvas>
                    </div>
                </div>
                <div class="glass-card fade-in" style="animation-delay: 0.4s">
                    <h2><i class="fa-solid fa-calendar-week"></i> Weekly Pattern</h2>
                    <div style="height:200px; width:100%">
                        <canvas id="chart-habit-week"></canvas>
                    </div>
                </div>
            </div>

            <div class="glass-card fade-in" style="animation-delay: 0.5s">
                <h2><i class="fa-solid fa-calendar-check"></i> Monthly Overview</h2>
                <div style="height:200px; width:100%; margin-bottom:1rem">
                    <canvas id="chart-habit-month"></canvas>
                </div>
                <div id="h-history"
                    style="display:flex; gap:4px; flex-wrap:wrap; justify-content:center; margin-top:1rem">
                    <!-- Heatmap dots generated here -->
                </div>
            </div>
        </div>
    </div>

    <!-- SCRIPT -->
    <script>
        // CONFIG
        const SB_URL = 'https://gmrqcoisfoghljwqiuys.supabase.co';
        const SB_KEY = 'sb_publishable_32HScVBfGlv4rNKr8kx-1A_dOyIPLEV';
        const client = window.supabase.createClient(SB_URL, SB_KEY);

        // PARAMS PARSING (Supports Query ?id=... OR Hash #/uid/tid)
        function getParams() {
            // 1. Try Hash Route: #/userId/taskId OR #/userId/habitId
            const hash = window.location.hash; // e.g., "#/123/456"
            if (hash && hash.includes('/')) {
                const parts = hash.replace('#', '').split('/').filter(p => p);
                if (parts.length >= 2) {
                    return {
                        userId: parts[0],
                        taskId: parts.length === 2 && !parts[1].startsWith('habit_') ? parts[1] : null,
                        habitId: parts.length === 2 && parts[1].startsWith('habit_') ? parts[1] : null
                        // Note: For explicit distinction, we might need a distinct path like #/user/task. 
                        // Assumed structure: #/USER_ID/ACTIVITY_ID. 
                        // To distinguish task vs habit, we'll check if the 2nd ID is task or habit in loadData or use a prefix in the URL like #/u/123/t/456
                    };
                }
                // Robust Hash Pattern: #/u/USER_ID/t/TASK_ID
                if (hash.includes('/u/')) {
                    const uIdx = parts.indexOf('u') + 1;
                    const tIdx = parts.indexOf('t') + 1;
                    const hIdx = parts.indexOf('h') + 1;
                    return {
                        userId: parts[uIdx],
                        taskId: tIdx > 0 ? parts[tIdx] : null,
                        habitId: hIdx > 0 ? parts[hIdx] : null
                    };
                }
            }

            // 2. Fallback to Query Params
            const p = new URLSearchParams(window.location.search);
            return {
                userId: p.get('userId'),
                taskId: p.get('taskId'),
                habitId: p.get('habitId')
            };
        }

        const { userId: USER_ID, taskId: TASK_ID, habitId: HABIT_ID } = getParams();

        // MOCK DATA GENERATOR (If IDs missing)
        const MOCK = {
            user: { Name: 'Demo User', location: 'Hyderabad, IN', role: 'Protege' },
            task: { name: 'Introduction to Meditation', description: 'Watch the introductory video and submit a summary.', deadline: new Date(Date.now() + 86400000 * 5).toISOString() },
            habit: { name: 'Morning Cleaning', description: 'Complete the morning cleaning process provided in the guide.' }
        };

        // INIT
        window.onload = async () => {
            if (!USER_ID) {
                // If opened without params, use demo mode or Error
                // alert("No User ID provided. Loading Demo Mode.");
            }

            await loadData();
        };

        async function loadData() {
            try {
                // 1. Fetch User
                let user = MOCK.user;
                if (USER_ID) {
                    const { data, error } = await client.from('Users').select('*').eq('id', USER_ID).single();
                    if (data) user = data;
                }
                renderUser(user);

                // 2. Fetch Context (Task or Habit)
                // 3. Fetch User History for Contextual Graphs (ADDED)
                const [allTasks, allHabits] = await Promise.all([
                    client.from('task_assignments').select('*, tasks(*)').eq('protege_id', user.id),
                    client.from('habit_assignments').select('*, habits(*)').eq('protege_id', user.id)
                ]);

                const history = { tasks: allTasks.data || [], habits: allHabits.data || [] };

                if (TASK_ID) {
                    await renderTaskView(user.id || 'mock_uid');
                    renderTaskCharts(history.tasks); // Render new charts
                } else if (HABIT_ID) {
                    await renderHabitView(user.id || 'mock_uid');
                    renderHabitCharts(history.habits); // Render new charts
                } else {
                    // Default to error or empty
                    document.getElementById('ctx-title').innerText = "No Activity Selected";
                }

                // Show Content
                setTimeout(() => {
                    document.getElementById('loader').style.display = 'none';
                    document.getElementById('main-content').classList.remove('hidden');

                    // Simple animation trigger
                    anime({
                        targets: '.value',
                        innerHTML: [0, (el) => el.innerHTML],
                        round: 1,
                        easing: 'easeInOutExpo',
                        duration: 1500
                    });
                }, 500);

            } catch (err) {
                console.error(err);
                alert("Error loading analytics: " + err.message);
                document.getElementById('loader').style.display = 'none';
            }
        }

        function renderUser(u) {
            document.getElementById('u-name').innerText = u.Name || 'Unknown User';
            document.getElementById('u-loc').innerText = u.location || 'Unknown Location';
            const initials = u.Name ? u.Name.substring(0, 2).toUpperCase() : '??';
            document.getElementById('u-avatar').innerText = initials;
            document.getElementById('u-badge').innerText = (u.role || 'User').toUpperCase();
        }

        async function renderTaskView(uid) {
            document.getElementById('view-task').classList.remove('hidden');
            document.getElementById('ctx-title').innerHTML = '<i class="fa-solid fa-list-check"></i> Task Analytics';

            // Get Task Details
            let task = MOCK.task;
            let assignment = null;

            if (TASK_ID) {
                // Parallel fetch task meta and specific user assignment
                const [tRes, aRes] = await Promise.all([
                    client.from('tasks').select('*').eq('id', TASK_ID).single(),
                    client.from('task_assignments').select('*').eq('task_id', TASK_ID).eq('protege_id', uid).maybeSingle()
                ]);
                if (tRes.data) task = tRes.data;
                if (aRes.data) assignment = aRes.data;
            }

            // Render Info
            document.getElementById('ctx-name').innerText = task.name;
            document.getElementById('ctx-desc').innerText = task.description || 'No description provided.';
            document.getElementById('ctx-meta-label').innerText = "Deadline";
            document.getElementById('ctx-meta-val').innerText = new Date(task.deadline).toLocaleDateString();

            // Stats
            const isDone = assignment?.status === 'completed';
            const statusEl = document.getElementById('t-status');
            statusEl.innerText = assignment ? assignment.status : 'Not Started';
            statusEl.style.color = isDone ? 'var(--accent)' : 'var(--text-main)';

            if (isDone) confetti({ particleCount: 100, spread: 70, origin: { y: 0.6 } });

            const today = new Date();
            const due = new Date(task.deadline);
            const diff = Math.ceil((due - today) / (1000 * 60 * 60 * 24));
            const daysEl = document.getElementById('t-days');
            daysEl.innerText = diff > 0 ? `${diff} Days` : (isDone ? 'Completed' : 'Overdue');
            daysEl.style.color = diff < 0 && !isDone ? '#EF4444' : 'var(--text-main)';

            // Chart: Peer Comparison (Mock/Real Mix)
            // Logic: Compare this user's completion time vs avg of all users for this task
            // Since we might not have complex history data easily, we'll mock the 'Average'
            const ctx = document.getElementById('chart-task-peer');
            const userScore = isDone ? 10 : 2; // Arbitrary score based on status
            new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: ['You', 'Cohort Avg', 'Top Performers'],
                    datasets: [{
                        label: 'Completion Velocity Score',
                        data: [userScore, 6, 9],
                        backgroundColor: ['#4F46E5', '#CBD5E1', '#10B981'],
                        borderRadius: 8
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: { y: { beginAtZero: true, display: false }, x: { grid: { display: false } } }
                }
            });
        }

        async function renderHabitView(uid) {
            document.getElementById('view-habit').classList.remove('hidden');
            document.getElementById('ctx-title').innerHTML = '<i class="fa-solid fa-repeat"></i> Habit Insights';

            let habit = MOCK.habit;
            let streakInfo = { current_streak: 0, longest_streak: 0 };

            if (HABIT_ID) {
                const [hRes, sRes] = await Promise.all([
                    client.from('habits').select('*').eq('id', HABIT_ID).single(),
                    client.from('habit_streaks').select('*').eq('habit_id', HABIT_ID).eq('protege_id', uid).maybeSingle()
                ]);
                if (hRes.data) habit = hRes.data;
                if (sRes.data) streakInfo = sRes.data;
            }

            document.getElementById('ctx-name').innerText = habit.name;
            document.getElementById('ctx-desc').innerText = habit.description || 'Track your consistency.';
            document.getElementById('ctx-meta-label').innerText = "Frequency";
            document.getElementById('ctx-meta-val').innerText = "Daily";

            document.getElementById('h-streak').innerText = (streakInfo.current_streak || 0) + " Days";
            document.getElementById('h-best').innerText = (streakInfo.longest_streak || 0) + " Days";

            // Consistency Chart (Mocked relative data simulating last 30 days)
            const days = Array.from({ length: 30 }, (_, i) => i + 1);
            // Generate a curve that generally goes up but might have dips
            const generateTrend = () => {
                let curr = 50;
                return days.map(d => {
                    curr += Math.random() * 20 - 8;
                    if (curr > 100) curr = 100; if (curr < 0) curr = 0;
                    return curr;
                });
            };

            new Chart(document.getElementById('chart-habit-trend'), {
                type: 'line',
                data: {
                    labels: days.map(d => `Day ${d}`),
                    datasets: [{
                        label: 'Consistency Score',
                        data: generateTrend(),
                        borderColor: '#10B981',
                        backgroundColor: (ctx) => {
                            const canvas = ctx.chart.ctx;
                            const gradient = canvas.createLinearGradient(0, 0, 0, 200);
                            gradient.addColorStop(0, 'rgba(16, 185, 129, 0.4)');
                            gradient.addColorStop(1, 'rgba(16, 185, 129, 0)');
                            return gradient;
                        },
                        fill: true,
                        tension: 0.4,
                        pointRadius: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: { x: { display: false }, y: { display: false, min: 0, max: 100 } }
                }
            });

            // Activity Heatmap (Last 14 days dots)
            const histContainer = document.getElementById('h-history');
            for (let i = 0; i < 30; i++) {
                const dot = document.createElement('div');
                const active = Math.random() > 0.3; // Random history for demo if real log missing
                dot.style.cssText = `width:12px; height:12px; border-radius:3px; background:${active ? '#10B981' : '#E2E8F0'}; transition:0.2s`;
                dot.title = active ? 'Completed' : 'Missed';
                histContainer.appendChild(dot);
            }
        }
        // --- EXTENDED CHART RENDERERS ---
        function renderTaskCharts(history) {
            // 2. Timeliness Trend (Last 5 assignments)
            const recent = history.slice(-5);
            const cleanlinessData = recent.length ? recent.map((t) => {
                // Mocking 'days before deadline' if we don't have submission date. 
                // If status is 'completed', assume random good performance for demo.
                return t.status === 'completed' ? Math.floor(Math.random() * 4) : -1;
            }) : [2, 1, 0, 3, 2]; // Fallback mock

            new Chart(document.getElementById('chart-task-time'), {
                type: 'line',
                data: {
                    labels: recent.length ? recent.map((_, i) => `Task ${i + 1}`) : ['T1', 'T2', 'T3', 'T4', 'T5'],
                    datasets: [{
                        label: 'Days Before Deadline',
                        data: cleanlinessData,
                        borderColor: '#4F46E5',
                        backgroundColor: 'rgba(79, 70, 229, 0.1)',
                        fill: true,
                        tension: 0.4
                    }]
                },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { y: { beginAtZero: true } } }
            });

            // 3. Category Radar
            new Chart(document.getElementById('chart-task-cat'), {
                type: 'radar',
                data: {
                    labels: ['Knowledge', 'Experimental', 'Consistency', 'Quality', 'Speed'],
                    datasets: [{
                        label: 'Your Profile',
                        data: [8, 7, 9, 8, 6],
                        backgroundColor: 'rgba(16, 185, 129, 0.2)',
                        borderColor: '#10B981',
                        pointBackgroundColor: '#10B981'
                    }]
                },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { r: { ticks: { display: false } } } }
            });
        }

        function renderHabitCharts(history) {
            // 2. Day of Week Analysis (Polar)
            new Chart(document.getElementById('chart-habit-week'), {
                type: 'polarArea',
                data: {
                    labels: ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'],
                    datasets: [{
                        data: [12, 19, 15, 17, 14, 22, 25],
                        backgroundColor: ['#4F46E588', '#10B98188', '#F59E0B88', '#EF444488', '#8B5CF688', '#EC489988', '#3B82F688'],
                        borderWidth: 0
                    }]
                },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'right' } }, scales: { r: { ticks: { display: false } } } }
            });

            // 3. Monthly Breakdown (Bar)
            new Chart(document.getElementById('chart-habit-month'), {
                type: 'bar',
                data: {
                    labels: ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun'],
                    datasets: [{
                        label: 'Completion Rate %',
                        data: [65, 78, 80, 85, 76, 92],
                        backgroundColor: '#4F46E5',
                        borderRadius: 4
                    }]
                },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { y: { max: 100 } } }
            });
        }
    </script>
</body>

</html>
